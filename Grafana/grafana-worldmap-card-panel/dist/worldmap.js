"use strict";System.register(["lodash","jquery","./libs/leaflet","./ocean","./twn","./cn","./countries","app/core/core"],function(a,b){function c(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var d,e,f,g,h,i,j,k,l,m,n,o,p;return{setters:[function(a){d=a["default"]},function(a){e=a["default"]},function(a){f=a["default"]},function(a){g=a.ocean},function(a){h=a.twn},function(a){i=a.china},function(a){j=a.countries},function(a){k=a.appEvents}],execute:function(){l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},m=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),n={"CartoDB Positron":{url:"https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd"},"CartoDB Dark":{url:"https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png",attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd"}},o=[],p=function(){function a(b,d){return c(this,a),this.ctrl=b,this.mapContainer=d,this.circles=[],this.cards=b.panel.cards,this.side=null,this.Ocean=null,this.CHN=null,this.TWN=null,this.zoomstart=0,this.createMap()}return m(a,[{key:"createMap",value:function(){var a=window.L.latLng(parseFloat(this.ctrl.panel.mapCenterLatitude),parseFloat(this.ctrl.panel.mapCenterLongitude));this.map=window.L.map(this.mapContainer,{worldCopyJump:!0,center:a,zoom:parseInt(this.ctrl.panel.initialZoom)||3,zoomDelta:.25,zoomSnap:0,doubleClickZoom:!1}),this.map.scrollWheelZoom.disable();var b=n[this.ctrl.tileServer];window.L.tileLayer(b.url,{maxZoom:18,subdomains:b.subdomains,reuseTiles:!0,detectRetina:!0,attribution:b.attribution}).addTo(this.map)}},{key:"createLegend",value:function(){}},{key:"createSideDisplay",value:function(){var a=this;this.side=window.L.control(),this.side.onAdd=function(){a.side._div=window.L.DomUtil.create("div","side-info-container"),a.side._div.innerHTML="";var b=a.ctrl.cardWidthChange(a.ctrl.panel.cardwidth);return a.side._div.style.width=b,a.side.update(),a.side._div},this.side.update=function(){for(var b=0;b<a.cards.length;b++)""!==a.cards[b].location&&(a.cards[b].thresholdsOption?a.cards[b].thresholdsLabel==a.cards[b].thresholdstmp.length?(a.side._div.innerHTML+=a.cards[b].sideContent,a.side._div.innerHTML+='<div class="side-display-space"></div>'):a.checkNumberNotEmpty(a.cards[b].thresholdsData)&&a.cards[b].thresholdsData>=a.cards[b].thresholdstmp[+a.cards[b].thresholdsLabel]?(a.side._div.innerHTML+=a.cards[b].sideContent,a.side._div.innerHTML+='<div class="side-display-space"></div>'):null==a.cards[b].thresholdsLabel&&a.cards[b].thresholdsIndex===a.cards[b].thresholdstmp.length&&(a.side._div.innerHTML+=a.cards[b].sideContent,a.side._div.innerHTML+='<div class="side-display-space"></div>'):a.cards[b].sideDisplay&&(a.side._div.innerHTML+=a.cards[b].sideContent,a.side._div.innerHTML+='<div class="side-display-space"></div>'))},this.side.addTo(this.map)}},{key:"filterEmptyAndZeroValues",value:function(a){var b=this;return d.filter(a,function(a){return!(b.ctrl.panel.hideEmpty&&d.isNil(a.value)||b.ctrl.panel.hideZero&&0===a.value)})}},{key:"clearCircles",value:function(){this.circlesLayer&&(this.circlesLayer.clearLayers(),this.removeCircles(this.circlesLayer),this.circles=[]),this.cleardropdownData()}},{key:"MapColorSetting",value:function(){this.ctrl.panel.oceanEnable?(this.removeOcean(),this.Ocean=window.L.geoJson(g,{fill:!0,stroke:!1,color:this.ctrl.panel.ocean,fillColor:this.ctrl.panel.ocean,fillOpacity:.8}),console.log(this.Ocean),this.Ocean.addTo(this.map)):this.removeOcean(),this.ctrl.panel.boundaryEnable?(this.removeBoundary(),this.Countries=window.L.geoJson(j,{fill:!0,color:this.ctrl.panel.boundaryStroke,fillColor:this.ctrl.panel.boundaryFill,opacity:.8,fillOpacity:.8,weight:2}),this.Countries.addTo(this.map)):this.removeBoundary()}},{key:"drawCircles",value:function(){this.MapColorSetting(),this.removeSide(),this.clearCircles(),this.checkThresholdColorCount(),this.checkCardLocation(),this.createCircles(),this.createSideDisplay()}},{key:"getFontSize",value:function(a){if(this.ctrl.panel.adjFontSize)for(var b=0;b<this.ctrl.fontCalc.length;b++)if(this.ctrl.fontCalc[b].text===a)return this.ctrl.fontCalc[b].value;return a}},{key:"cardSetting",value:function(a){var b='<div class="card-title">'+a.title+"</div>",c="";if(a.cardItems){for(var e='<table style="table-layout:fixed;word-wrap: break-word;">',f=0;f<a.cardItems.length;f++)if("caption"===a.cardItems[f].type)c+='<tr class="cardCaption" style="font-size:'+this.getFontSize(this.ctrl.panel.FontSize)+';"><td class colspan="2">'+a.cardItems[f].name+"</td></tr>";else if("data"===a.cardItems[f].type){if(null!==a.cardItems[f].dataIndex&&null!==a.cardItems[f].dataTag&&null!==a.cardItems[f].dataTag&&"dataTag"in a.cardItems[f]){if(a.cardItems[f].dataIndex<a.data.length){if(a.cardItems[f].dataTag!==a.data[a.cardItems[f].dataIndex].text){a.cardItems[f].dataIndex=null;for(var g=0;g<a.data.length;g++)a.data[g].text==a.cardItems[f].dataTag&&(a.cardItems[f].dataIndex=g)}}else{a.cardItems[f].dataIndex=null;for(var g=0;g<a.data.length;g++)a.data[g].text==a.cardItems[f].dataTag&&(a.cardItems[f].dataIndex=g)}if(!(null==a.cardItems[f].dataIndex||this.ctrl.panel.hideEmpty&&d.isNil(a.data[a.cardItems[f].dataIndex].value)||this.ctrl.panel.hideZero&&0===a.data[a.cardItems[f].dataIndex].value)){a.cardItems[f].value=a.data[a.cardItems[f].dataIndex].value;var h=a.cardItems[f].postfix?a.cardItems[f].postfix:"",i=a.cardItems[f].decimals?a.cardItems[f].value.toFixed(parseInt(a.cardItems[f].decimals)):a.cardItems[f].value,j="CartoDB Positron"===this.ctrl.tileServer?"#323233":"#ffffff";if(a.thresholdsOption&&a.thresholdsIndex>-1&&a.thresholdsDataTag){console.log("Threshold");for(var k=a.thresholdstmp.length;k>=0;k-=1)if(+a.thresholdsData>=a.thresholdstmp[k-1]){a.thresholdsIndex=k;break}a.thresholdsIndex>-1&&(j=a.cardItems[f].dataTag==a.thresholdsDataTag?this.ctrl.panel.colors[a.thresholdsIndex]:j)}c+='<tr class="cardInfo" style="font-size:'+this.getFontSize(this.ctrl.panel.FontSize)+';"><td><a class= "aCardInfo" style="text-decoration: none;" target="_self" href="'+a.cardItems[f].link+'">'+a.cardItems[f].name+"</a></td>",c+='<td class="Content" style="color:'+j+';">'+i+h+"</td></a></tr>"}}if(!("dataTag"in a.cardItems[f])){a.data[a.cardItems[f].dataIndex]&&(a.cardItems[f].value=a.data[a.cardItems[f].dataIndex].value,a.cardItems[f].dataTag=a.data[a.cardItems[f].dataIndex].text);var h=a.cardItems[f].postfix?a.cardItems[f].postfix:"",i=a.cardItems[f].decimals?a.cardItems[f].value.toFixed(parseInt(a.cardItems[f].decimals)):a.cardItems[f].value;c+='<tr class="cardInfo" style="font-size:'+this.getFontSize(this.ctrl.panel.FontSize)+';"><td><a class= "aCardInfo" style="text-decoration: none;" target="_self" href="'+a.cardItems[f].link+'">'+a.cardItems[f].name+"</a></td>",c+='<td class="Content">'+i+h+"</td></a></tr>"}}else"info"===a.cardItems[f].type&&(c+='<tr class="cardInfo" style="font-size:'+this.getFontSize(this.ctrl.panel.FontSize)+';"><td><a class= "aCardInfo" style="text-decoration: none;" target="_self" href="'+a.cardItems[f].link+'">'+a.cardItems[f].name+"</a></td>",c+='<td class="Content">'+a.cardItems[f].value+"</td></a></tr>");c.length>0?(b=b+e+c+"</table>",a.sideContent=b):a.sideContent=""}}},{key:"createCircles",value:function(){var a=this,b=this.filterEmptyAndZeroValues(this.ctrl.data),c=[],d=!1,e="";this.ctrl.panel.locationList=[],this.dropdownData(this.ctrl.data);var f=[];this.addThresholdsData(this.cards);for(var g=0;g<this.cards.length;g++)this.cardSetting(this.cards[g]);b.forEach(function(b){b.locationName&&(e=b.locationName+"_"+b.locationLatitude+"_"+b.locationLongitude,0===f.length?c.push(a.createCircle(b,e)):(d=f.includes(e),d===!1&&c.push(a.createCircle(b,e))))}),this.circlesLayer=this.addCircles(c),this.circles=c}},{key:"createCircle",value:function(a,b){for(var c=this,d=0;d<this.cards.length;d++)if(b===this.cards[d].location){var e=function(){c.updateThresholdData(c.cards[d]);var b=window.L.circleMarker([a.locationLatitude,a.locationLongitude],{radius:c.calCircleSize(c.cards[d],d),color:c.getColor(c.cards[d]),fillColor:c.getColor(c.cards[d]),fillOpacity:.8,location:a.key,locationName:a.locationName}),e=c.cards[d].link;return""!==e&&b.on("click",function(a){return window.location.href.indexOf("/frame/")!==-1?void k.emit("preventUrlGo",e):void window.open(e,"_self")}),c.createPopup(b,c.cards[d].sideContent),{v:b}}();if("object"===("undefined"==typeof e?"undefined":l(e)))return e.v}var f=window.L.circleMarker([a.locationLatitude,a.locationLongitude],{radius:this.ctrl.panel.circleCurrentSize,color:"rgb(90, 200, 250)",fillColor:"rgb(90, 200, 250)",fillOpacity:.8,location:a.key,locationName:a.locationName});return f}},{key:"dropdownData",value:function(a){var b="",c=0;this.ctrl.panel.dataMax="",this.ctrl.panel.dataMin="";for(var d=0;d<a.length;d++)if(a[d].locationName&&a[d].locationLatitude&&a[d].locationLongitude){b=a[d].locationName+"_"+a[d].locationLatitude+"_"+a[d].locationLongitude,(a[d].value>this.ctrl.panel.dataMax||"string"==typeof this.ctrl.panel.dataMax)&&(this.ctrl.panel.dataMax=a[d].value),(a[d].value<this.ctrl.panel.dataMin||"string"==typeof this.ctrl.panel.dataMin)&&(this.ctrl.panel.dataMin=a[d].value),this.ctrl.panel.locationList.includes(b)||this.ctrl.panel.locationList.push(b);for(var e=0;e<this.cards.length;e++)this.cards[e].location===b&&(c=this.cards[e].data.length,this.cards[e].data.push({text:a[d].key,value:a[d].value,index:c}))}for(var f=0;f<this.cards.length;)!this.ctrl.panel.locationList.includes(this.cards[f].location)&&this.cards[f].location&&(this.ctrl.removeCard(f),f=0),f+=1}},{key:"cleardropdownData",value:function(){for(var a=0;a<this.cards.length;a++)this.cards[a].data=[]}},{key:"calCircleSize",value:function(a,b){if(this.checkNumberNotEmpty(this.ctrl.panel.circleMaxSize)&&this.checkNumberNotEmpty(this.ctrl.panel.circleMinSize)&&a.circleValue){if(+this.ctrl.panel.circleMaxSize>0&&+this.ctrl.panel.circleMinSize>0&&+this.ctrl.panel.circleMaxSize>+this.ctrl.panel.circleMinSize){for(var c=0;c<a.cardItems.length;c++)if(a.circleValue==a.cardItems[c].dataTag&&null!=a.cardItems[c].dataIndex)return this.checkNumberNotEmpty(a.cardItems[c].value)?(+a.cardItems[c].value-this.ctrl.panel.circleMinSize)*(+this.ctrl.panel.circleMaxSize-+this.ctrl.panel.circleMinSize)/(this.ctrl.panel.dataMax-this.ctrl.panel.dataMin)+this.ctrl.panel.circleMinSize:this.ctrl.panel.circleCurrentSize;return this.cards[b].circleValue="",this.ctrl.panel.circleCurrentSize}return this.ctrl.panel.circleCurrentSize}return this.ctrl.panel.circleCurrentSize}},{key:"createPopup",value:function(a,b){var c=(new Array,{offset:window.L.point(0,-2),className:"worldmap-popup"});a.bindPopup(b,c),a.on("mouseover",function(a){var b=a.target;b.bringToFront(),this.openPopup()});this.ctrl.panel.stickyLabels||this.map.on("mouseout",function(){a.closePopup()})}},{key:"getDataValue",value:function(a){var b=this.filterEmptyAndZeroValues(this.ctrl.data);if(a&&b){for(var c=0;c<b.length;c++)if(a===b[c].locationName)return b[c].value;return""}}},{key:"getThresholdsFontColor",value:function(a,b){for(var c=0,d=b.length;d>0;d-=1)a>=b[d-1]&&(c=d);return c>=this.ctrl.panel.colors.length&&(c=this.ctrl.panel.colors.length-1),c}},{key:"getColor",value:function(a){if(isNaN(a.thresholdsData))return a.circleColor;if("string"!=typeof a.thresholdsData||a.thresholdsData){if(a.thresholdsOption){for(var b=a.thresholdstmp.length;b>=0;b-=1)if(+a.thresholdsData>=a.thresholdstmp[b-1])return a.thresholdsIndex=b,this.ctrl.panel.colors[b];return a.thresholdsIndex=0,d.first(this.ctrl.panel.colors)}return a.circleColor}return a.circleColor}},{key:"updateThresholdData",value:function(a){a.thresholdstmp=a.thresholdsValue.split(",").map(function(a){return Number(a.trim())})}},{key:"resize",value:function(){this.map.invalidateSize()}},{key:"panToMapCenter",value:function(){this.map.panTo([parseFloat(this.ctrl.panel.mapCenterLatitude),parseFloat(this.ctrl.panel.mapCenterLongitude)]),this.ctrl.mapCenterMoved=!1}},{key:"removeLegend",value:function(){this.map.removeControl(this.legend),this.legend=null}},{key:"removeSide",value:function(){null!==this.side&&this.map.removeControl(this.side),this.side=null}},{key:"removeOcean",value:function(){null!==this.Ocean&&this.map.removeLayer(this.Ocean),this.Ocean=null}},{key:"removeBoundary",value:function(){null!==this.CHN&&this.map.removeLayer(this.CHN),this.CHN=null,null!==this.TWN&&this.map.removeLayer(this.TWN),this.TWN=null}},{key:"addCircles",value:function(a){return window.L.layerGroup(a).addTo(this.map)}},{key:"removeCircles",value:function(){this.map.removeLayer(this.circlesLayer)}},{key:"setZoom",value:function(a){this.map.setZoom(parseInt(a,10))}},{key:"remove",value:function(){this.circles=[],this.circlesLayer&&this.removeCircles(),this.legend&&this.removeLegend(),this.map.remove()}},{key:"updateZoomDelta",value:function(){this.ctrl.map.panel.zoomDelta=0}},{key:"updatethresholdsOption",value:function(a){a.thresholdsValue.length>0?a.thresholdsOption=!0:a.thresholdsOption=!1}},{key:"checkThresholdColorCount",value:function(){for(var a=0,b=0;b<this.cards.length;b++)this.cards[b].thresholdstmp=this.cards[b].thresholdsValue.split(",").map(function(a){return Number(a.trim())}),this.cards[b].thresholdstmp.length>a&&(a=this.cards[b].thresholdstmp.length);for(;d.size(this.ctrl.panel.colors)>a+1;)this.ctrl.panel.colors.pop();for(var c="";d.size(this.ctrl.panel.colors)<a+1;)c=2===d.size(this.ctrl.panel.colors)?"rgba(255,35,30, 0.8)":1===d.size(this.ctrl.panel.colors)?"rgba(255,183,0, 0.8)":"rgba(51,181,229, 0.8)",this.ctrl.panel.colors.push(c)}},{key:"addDataTag",value:function(a,b){null!=b.dataIndex&&(b.dataTag=a[b.dataIndex].text)}},{key:"checkCardLocation",value:function(){for(var a=0;a<this.cards.length;a++)this.ctrl.panel.locationList.includes(this.cards[a].location)||(this.cards[a].location="")}},{key:"checkNumberNotEmpty",value:function(a){return!isNaN(a)&&!("string"==typeof a&&!a)}},{key:"addThresholdsData",value:function(a){for(var b=0;b<a.length;b++)if(a[b].thresholdsDataTag){var c=a[b].data.find(function(c){return c.text.match(a[b].thresholdsDataTag)});c?a[b].thresholdsData=c.value:a[b].thresholdsDataTag=""}}}]),a}(),a("default",p)}}});
//# sourceMappingURL=worldmap.js.map